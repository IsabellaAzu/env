
# 以下のページの転載です。

## 公式MySQLコンテナでDockerコンテナの連携をしてみる
http://unskilled.site/%E5%85%AC%E5%BC%8Fmysql%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%A7docker%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E9%80%A3%E6%90%BA%E3%82%92%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B/

```
1:Dockerでのコンテナはなるべく最小限にする。だから連携が必要
1.1:1つプロセスで1つのコンテナ
2:コンテナ連携
2.1:linkオプションの使用例　公式のMySQLイメージの使用
2.2:MySQLサーバコンテナの作成・起動
2.2.1:セットアップに使う環境変数の意味
2.2.1.1:環境変数の種類
2.2.1.2:MYSQL_ROOT_PASSWORD
2.2.1.3:MYSQL_DATABASE
2.2.1.4:MYSQL_USER・MYSQL_PASSWORD
2.2.2:MySQLサーバコンテナ起動
2.2.2.1:コマンドの意味
2.3:クライアントコンテナの作成・起動
2.3.1:コマンドの意味
2.3.1.1:補足
2.4:クライアントからデータベースを見てみる
2.4.0.1:出力された環境変数
3:補足・ハマりポイント
3.1:公式MySQLのデータ永続化について
3.2:MySQLの設定の変更
3.3:文字コードについて
4:後記
```

## 1つプロセスで1つのコンテナ

Dokcerではできるだけ1つプロセスで1つのコンテナという構成が推奨されるとのことです。  
基本的にコンテナにはSSHなどでログインするのは推奨されていないようです。  
つまりサーバコンテナ側にsshdを立てるなということらしいです。  
なのでいくつかのアプリケーションを連携させるには、コンテナの連携を学ぶ必要がありそうです。  
コンテナをサーバみたく扱うことはできるのだけど、  
これだと後々なんらかのプロセスだけ差し替えたい、スケールしたいなどの場合に面倒になるようです。  
(テスト環境はGNU/Linux debian8)


- - -  

## コンテナ連携

### linkオプションの使用例　公式のMySQLイメージの使用

コンテナ連携にはlinkオプションを使う。  
データベースコンテナとクライアントコンテナの連携を例に進めていきたいと思います。  
公式MySQLイメージはすぐにデータベースを使うことができるように設計されています。  
`docker run`時にいくつかの設定をくっつけてあげれば、  
パスワード設定、データベース作成等を簡単に行うことができます。  

### MySQLサーバコンテナの作成・起動

まずは公式のMySQLイメージをpullします。テストなので特にバージョンを指定していません。
```
$ sudo dokcer pull mysql
```

### セットアップに使う環境変数の意味

`pull`ができたら`run`をするのですが、  
公式MySQLイメージでは簡単に環境変数をつかったデータベースのセットアップをすることができます。

### 環境変数の種類

公式MySQLイメージいくつかの環境変数が用意されており、`run`の`e`オプションでその変数を設定することができます。
環境変数の種類と意味は以下です。

| 環境変数 | 意味 |
|:-----------|:------------|
| MYSQL_DATABASE | イメージ起動時に作成されるデータベースの名前を指定することができます。ユーザー/パスワードを設定した場合（下記参照）、そのユーザーはこのデータベースへのスーパーユーザになります。（`GRANT ALL`に相当）|
| MYSQL_USER | 新しいユーザーを作成・パスワード付与のオプションです。このユーザーはMYSQL_DATABASE変数で指定されたデータベースのスーパーユーザになります。ユーザーを作成するためにはMYSQL_USER・MYSQL_PASSWORD両方の変数が必要です。どちらかだけだとエラーになります。 |
| MYSQL_PASSWORD | 〃 |
| MYSQL_ROOT_PASSWORD | MySQLのrootのパスワードを指定します。この変数の設定は必須です。これを設定しないとエラーが出て`run`が成功しません。 |
| MYSQL_ALLOW_EMPTY_PASSWORD | パスワードなしでログインできるようにする |

### MySQLサーバコンテナ起動
```
$ sudo docker run \
  --name containerName \
  -e MYSQL_ROOT_PASSWORD=password \
  -e MYSQL_USER=hogeuser \
  -e MYSQL_PASSWORD=hogepass \
  -e MYSQL_DATABASE=dbName \
  -d containerImageName:tag
```

#### コマンドの意味
| コマンド　| 意味　|
|:-----------|:------------|
| docker run | コンテナの作成及び起動 |
| –name hogedb | コンテナに名前をつけるオプション。例ではhogedb |
| -e MYSQL_ROOT_PASSWORD=password | rootのパスワード設定。例ではpassword |
| -e MYSQL_USER=hoge | ユーザの名前設定。例ではhoge |
| -e MYSQL_PASSWORD=hogepass | ユーザパスワード設定。例ではhogepass |
| -e MYSQL_DATABASE=db | 作成されるデータベースの名前。例ではdb |
| -d | デタッチ状態（バックグラウンド動作）での起動オプション |
| mysql | コンテナの元になるイメージ |






