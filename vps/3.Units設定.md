# 3.Units設定


<a id="anc1" name="anc1"></a>
## (1)nginx（全然分からんｗ）

コンテナの中にcentOSとか入れてyum installとかするもんなのか？  
http://webkaru.net/linux/centos-6-3-nginx-install/  
　↓  
http://9ensan.com/blog/server/sakura-vps-nginx-reverse-proxy/  
http://qiita.com/yakumomo/items/4ee2d0f13f24b8f024b6  
http://www.crystalsnowman.com/?p=749  
http://qiita.com/murachi1208/items/d04797b0b61e69018938  
https://sys-guard.com/yuu_linux/19-01.php  
http://labs.septeni.co.jp/entry/2015/11/19/213714  
http://qiita.com/hakaicode/items/38cbed889a03a33cdfcf  
http://qiita.com/NewGyu/items/d0b0d6074e13acd51f3e  

http://qiita.com/yakumomo/items/4ee2d0f13f24b8f024b6  
http://webkaru.net/linux/centos-6-3-nginx-install/  
https://academy.gmocloud.com/advance/20160808/3415  
http://cloudrop.jp/server/replace_nginx  
　  
http://qiita.com/ABE_TAKASHI/items/654ef6ed22071c93d6f2 （最終目標）  
http://takahiro0914.hatenablog.com/entry/2016/06/28/003520  


### dockerのリポジトリからイメージをpull(20170206のlatestで約180MBくらい)
```
# sudoしないと、「Cannot connect to the Docker daemon. Is the docker daemon running on this host?」
$ sudo docker pull nginx
# imageの確認
$ sudo docker images

# コンテナ作成
$ sudo docker run --privileged -td -p 80:80 -v aaa:/Docker --name=aaa nginx /sbin/init
# --privileged : 
# -td : 
# -p 80:80 : 80から来たのをコンテナの80ポートに転送
# -v aaa:/Docker : -volumeのエイリアスで、aaaフォルダと/Dockerを共有
# --name=aaa : aaaのコンテナ名で起動
# nginx : dockerにあるイメージ名
# /sbin/init : ルート権限みたいなもの？
```
imageの格納先は、「/var/lib/docker/」（[詳細](http://deeeet.com/writing/2013/12/16/where-are-docker-images-storede/)）  


### nginxの入ったコンテナに
https://docs.docker.com/engine/reference/commandline/exec/
```
# 入る
$ docker exec -it aaa /bin/bash
# -i : --interactiveのエイリアス
# -t : --ttyのエイリアス

# 出る
$ exit
```

## (2)Fleet
Fleetの使い方，Unitファイルの書き方  
http://deeeet.com/writing/2014/11/20/fleet/  
http://knowledge.sakura.ad.jp/tech/2519/#サービスの登録  


## (3)etcd


## (4)flannel
複数ホスト間で複数コンテナ間の通信を行える  
http://qiita.com/umchifre/items/74abfa8dfb054c87d168


## (5)ntpd
ntp：ホストにもなれる、systemd-timesyncd：クライアントのみ  

### ホストOSのｔｉｍｅｚｏｎｅ設定(UTC→Japan)
```
# 現在の時刻設定を確認
$ date
=> Thu Feb 23 11:42:31 UTC 2017
```
```
#cloud-config.ymlにｔｉｍｅｚｏｎｅの設定
coreos:
  units:
  - name: settimezone.service
    command: start
    content: |
      [Unit]
      Description=Set the timezone
      [Service]
      ExecStart=/usr/bin/ln -sf ../usr/share/zoneinfo/Japan /etc/localtime
      RemainAfterExit=yes
      Type=oneshot
```
```
# cloud-config.ymlの設定を反映
$ sudo coreos-cloudinit -from-file=./cloud-config.yml
```
```
# 設定後の時刻設定を確認
$ date
=> Thu Feb 23 20:43:44 JST 2017
```

### ホストOSの時刻同期先の設定

#### デフォルト設定の確認
```
# /etc/ntp.confのデフォルト設定
# Common pool
server 0.coreos.pool.ntp.org
server 1.coreos.pool.ntp.org
server 2.coreos.pool.ntp.org
server 3.coreos.pool.ntp.org

# Warning: Using default NTP settings will leave your NTP
# server accessible to all hosts on the Internet.

# If you want to deny all machines (including your own)
# from accessing the NTP server, uncomment:
#restrict default ignore

# Default configuration:
# - Allow only time queries, at a limited rate, sending KoD when in excess.
# - Allow all local queries (IPv4, IPv6)
restrict default nomodify nopeer noquery limited kod
restrict 127.0.0.1
restrict [::1]
```

# cloud-config.ymlに設定
時刻同期先サーバーの設定、既存ｃｏｒｅＯＳの時刻同期デーモンの停止、新規時刻同期デーモンの起動
```
# 公開NTPサーバーを指定(ntp.jst.mfeed.ad.jp)
write_files:
- path: /etc/ntp.conf
    content: |
      # Common pool
      server ntp.jst.mfeed.ad.jp
      # - Allow only time queries, at a limited rate.
      # - Allow all local queries (IPv4, IPv6)
      restrict default nomodify nopeer noquery limited kod
      restrict 127.0.0.1
      restrict [::1]
coreos:
  units:
  # "stop" default coreOS NTP daemon
  - name: systemd-timesyncd.service
    command: stop
    mask: true
  # "start" new user NTP daemon
  - name: ntpd.service
    command: start
    enable: true
```
```
# cloud-config.ymlの設定を反映
$ sudo coreos-cloudinit -from-file=./cloud-config.yml
```
```
# ntpdの状態確認
$ systemctl status ntpd
=>● ntpd.service - Network Time Service
=>  Loaded: loaded (/usr/lib/systemd/system/ntpd.service; disabled; vendor preset: disabled)
=>  Active: inactive (dead)


# 
$ sudo ntpdate
```


http://qiita.com/spesnova/items/018b74ea1cc0a9e8787d  
※MySQLでcreated_atとかの時間はどうなるのだろうか？  
　  
KVMにおいて ホストとゲストの時間管理はNTPを用いるべきか？  
http://server-setting.info/centos/kvm-guest-host-ntp.html  
サーバーの時計（日時）を合わせる方法  
http://server-setting.info/centos/server-set-date.html  


## (6)複数コンテナ管理
docker-compose.ymlで、MySQL,nginx,appの設定  
http://qiita.com/yoshihiro/items/2aa7d3baff94cc1016ee  
各コンテナの時刻設定は、「/etc/localtime」  
http://qiita.com/Gin/items/9f22ce8639aaa9f656dc  
```
# ホストOSの時刻設定を見る
$ docker run -v /etc/localtime:/etc/localtime:ro
```


- - - 
　  
## index
<a href="./readme.md">readme.md</a>  
<a href="./1.OSインストール.md">1.OSインストール</a>  
<a href="./2.OS設定.md">2.OS設定</a>  
3.Units設定  
<a href="./4.ユーザー設定.md">4.ユーザー設定</a>  
　  
