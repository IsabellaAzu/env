# 3.Units設定
　  
　  
<a id="anc1" name="anc1"></a>
## (1)コンテナ
CoreOS で起動中のコンテナの中に入る  
http://qiita.com/spesnova/items/8121615d4634500a331c  
Dockerコマンドメモ  
http://qiita.com/curseoff/items/a9e64ad01d673abb6866  
Dockerのすべてが5分でわかるまとめ!(コマンド一覧付き)  
http://paiza.hatenablog.com/entry/docker_intro  
よく使うDockerコマンド  
http://qiita.com/noralife/items/18301143c20cc5172c56  




#### (1-1)コンテナの管理

##### (1-1-1)コンテナベースイメージの容量比較  

| [Alpine](https://alpinelinux.org/)| CentOS| Ubuntu|  Debian|
|:------|------:|------:|:------:|
|  4.0MB|196.8MB|122.0MB|125.1 MB|

Alpine Linux使ってみた  
http://qiita.com/tukiyo3/items/247f853c81bf00e82c11  

```command
# コンテナのイメージ取得
$ sudo docker pull alpine
# ホストのコンテナイメージ一覧
$ sudo docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
alpine              latest              xxxxxxxxxxxx        6 weeks ago         3.984 MB
```

##### (1-1-2)docker hub private repository
コンテナイメージの保存先。アカウントとリポジトリを作っておく。１個まで無料。  
https://hub.docker.com/


##### (1-1-3)Container orchestration

###### docker-compose

CoreOSにdocker-composeを導入  
http://qiita.com/hiroseabook/items/50bda4b0fd85ab228c6d  
http://cortyuming.hateblo.jp/entry/2015/04/26/164606  
```command
# rootに変身して、rootのホームディレクトリに勝手に移動
$ sudo su -
# インストール先のディレクトリ作成
$ mkdir -p /opt/bin # /usr/local/bin/だとcoreOSでは
# インストール
$ sudo curl -L https://github.com/docker/compose/releases/download/1.13.0/docker-compose-`uname -s`-`uname -m` > /opt/bin/docker-compose

# インストールできたか確認
$ docker-compose -v
> -su: /opt/bin/docker-compose: Permission denied
# アクセス権と状態の表示
$ ls -l /opt/bin/docker-compose
> -rw-r--r--. 1 root root 8273264 May 10 15:20 /opt/bin/docker-compose
# アクセス権の変更
$ chmod +x /opt/bin/docker-compose
> -rwxr-xr-x. 1 root root 8273264 May 10 15:20 /opt/bin/docker-compose
# インストールできたか再確認
$ docker-compose -v
> docker-compose version 1.13.0, build 1719ceb
```
※[sudo su とハイフン有り無しの違いについて](http://javatechnology.net/service/sudo-su-hyphen/)  

設定ファイルdocker-compose.ymlの用意  
http://qiita.com/ABE_TAKASHI/items/654ef6ed22071c93d6f2  
https://webnaut.jp/technology/20170126-1990/  
```yml
# 任意のディレクトリにdocker-compose.yml

【編集中】

version: '2'
services:
  proxy:
    image: jwilder/nginx-proxy
    privileged: true
    ports:
      - 80:80
    volumes:
      - /etc/nginx/vhost.d
      - /usr/share/nginx/html
      - /var/run/docker.sock:/tmp/docker.sock:ro
    container_name: XXX
mysite_db:
    image: mysql
    environment:
      MYSQL_ROOT_PASSWORD: password
  mysite:
    image: wordpress
    environment:
      WORDPRESS_DB_PASSWORD: password
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_HOST: mysite_db:3306
      WORDPRESS_DB_NAME: mysite
      VIRTUAL_HOST: IPアドレス、ドメイン名など
      VIRTUAL_PORT: 80
    links:
      - mysite_db

```
※[docker-compose.ymlのkey−value](http://docs.docker.jp/compose/compose-file.html#image)
http://unskilled.site/%E4%BD%BF%E3%81%84%E6%96%B9%E5%9F%BA%E6%9C%AC%E7%89%88dockercompose%E3%81%A7%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92%E3%83%BB%E9%80%A3%E6%90%BA%E3%82%92%E6%A5%BD/  
http://qiita.com/KappaBull/items/15de7a2bf52a5d38b11e  

```command
# dockerのimageを元にコンテンを新規作成し起動
$ sudo docker-compose up -d
```



###### Container orchestration参考情報
composeとswarm  
https://www.slideshare.net/zembutsu/introduction-to-docker-compose-and-swarm  
CoreOSにdocker-composeを導入  
http://qiita.com/hiroseabook/items/50bda4b0fd85ab228c6d  
docker-composeを使うと複数コンテナの管理が便利に  
http://qiita.com/y_hokkey/items/d51e69c6ff4015e85fce  
docker-compose、docker-swarm、kubernetes  
https://bitgandtter.blog/2015/11/19/docker-compose-docker-swarm-or-kubernetes/  
https://www.infoq.com/jp/news/2016/07/dockercon-docker-swarm  
https://hackerslog.net/post/labs/docker-letsencrypt-on-docker-and-nginx/  
Docker SwarmとKubernetesの比較  
https://www.creationline.com/lab/13762  

- - - 
　  
## (2)nginx

#### (2-1) alpineベースのnginxコンテナイメージの取得  
https://hub.docker.com/r/_/nginx/  
https://wiki.alpinelinux.org/wiki/Nginx  

```cmd
$ sudo docker pull nginx:alpine
```

#### (2-2) nginxコンテナの単体起動
```cmd
# /bin/bashじゃないんですねｗ　これ探すのに苦労した
$ sudo docker run --name nginx_test -it -p 8080:80 nginx:alpine /bin/sh
```

#### (2-3) nginxコンテナの設定
基本は[公式](https://wiki.alpinelinux.org/wiki/Nginx)通りに進めてみる。
```cmd
# nginx_testコンテナの中

# ユーザー、グループ作成
    # -D : Don`t assign a password
    # -u : User idの指定
    # -g : GECOS field
/ # adduser -D -u 1000 -g 'www' www

# ディレクトリ作成、ディレクトリの所有者変更
/ # mkdir /www
/ # chown -R www:www /var/lib/nginx # これできないかも、できなくても大丈夫そう
/ # chown -R www:www /www

# 設定ファイルのバックアップ
/ # mv /etc/nginx/nginx.conf /etc/nginx/nginx.conf.orig


# テスト表示ページの用意
/ # vi /www/index.html

# 設定ファイルの用意（下記記載）
/ # vi /etc/nginx/nginx.conf

# nginxの起動
/ # nginx

# 接続中のコンテナから、起動したまま抜ける
→ Ctrl を押したままP、Q の順番でキーを押す

# 起動中のコンテナ確認
$ sudo docker ps
```

```cmd
# nginx_testコンテナの中
adduser -D -u 1000 -g 'www' www
mkdir /www
chown -R www:www /www
mv /etc/nginx/nginx.conf /etc/nginx/nginx.conf.orig
vi /www/index.html

vi /etc/nginx/nginx.conf

nginx

→ Ctrl を押したままP、Q の順番でキーを押す
```



※[GECOS field](https://uc2.h2np.net/index.php/GECOS%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89)  

```
# /etc/nginx/nginx.conf
user                            www;
worker_processes                1;

error_log                       /var/log/nginx/error.log warn;
pid                             /var/run/nginx.pid;

events {
    worker_connections          1024;
}

http {
    include                     /etc/nginx/mime.types;
    default_type                application/octet-stream;
    sendfile                    on;
    access_log                  /var/log/nginx/access.log;
    keepalive_timeout           3000;
    server {
        listen                  80;
        root                    /www;
        index                   index.html index.htm;
        server_name             localhost;//独自ドメインなど



        # IPアドレス直打ちアクセスをforbidden
        if ($host != "ドメイン名") {
            return 403;
        }

        # 特定のIPアドレスをはじく
        allow xxx.xxx.xxx.xxx;
        deny all;

        client_max_body_size    32m;
        error_page              500 502 503 504  /50x.html;
        location = /50x.html {
              root              /var/lib/nginx/html;
        }
    }
}
```
Nginx設定のまとめ  
http://qiita.com/syou007/items/3e2d410bbe65a364b603  



目標  
http://qiita.com/ABE_TAKASHI/items/654ef6ed22071c93d6f2  
http://qiita.com/aild_arch_bfmv/items/d47caf37b79e855af95f  
  

☆個人運営サイトのSSLをDockerで良い感じに設定する  
（JrCs/docker-letsencrypt-nginx-proxy-companion、jwilder/nginx-proxy）  
http://qiita.com/KappaBull/items/15de7a2bf52a5d38b11e  
　  
- - - 
　  
## (3)nginx-proxy
https://github.com/jwilder/nginx-proxy  
https://suin.io/531

```
# コンテナイメージを取得
$ sudo docker pull jwilder/nginx-proxy:alpine
# コンテナの起動
$ sudo docker run -d -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy:alpine
```
どれが正解か分からない
```
$ sudo docker run --name jnginx-proxy -d -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy:alpine
$ sudo docker run -e VIRTUAL_HOST=ドメイン

$ sudo docker run --name jnginx-proxy -e VIRTUAL_HOST=ドメイン -d -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy:alpine

```

http://knowledge.sakura.ad.jp/tech/3142/  
http://qiita.com/ryo_dg/items/e0cc93e6a8688e5116c8  
http://qiita.com/sigelinde/items/95c154dc807a4bbc9cf0  

```
# コンテナの起動(プロダクションで運用起動例)
sudo docker run \
    --detach \
    --name nginx-proxy \
    --publish 80:80 \
    --publish 443:443 \
    --volume /var/run/docker.sock:/tmp/docker.sock:ro \
    --volume /certs:/etc/nginx/certs:ro \
    --restart always \
    --log-opt max-size=5m \
    --log-opt max-file=10 \
    jwilder/nginx-proxy:alpine
```

nginx-proxy, docker-gen という便利ツール  
https://blog.1q77.com/2016/02/nginx-proxy-and-docker-gen/  
nginxとdocker-genとその他を使って良い感じにする（1）  
http://poyo.hatenablog.jp/entry/2017/02/18/154031  
VirtualHostをお手軽に実現できるDockerコンテナnginx-proxyの起動方法  
https://suin.io/531  

- - - 
　  
## ()jrcs/letsencrypt-nginx-proxy-companion
証明書、basic認証のファイルを置くディレクトを作成  
https://blog.local-c.com/archives/1866  


- - - 
　  
## httpsでサービス起ち上げ
- [jrcs/letsencrypt-nginx-proxy-companion](https://hub.docker.com/r/jrcs/letsencrypt-nginx-proxy-companion/)
- 
- 


- - - 
　  
## (4)etcd
クラスタを構築する(2パターン)(サービスが大きくなったら使う？)  
1.あらかじめマシン数が決まっている場合に静的にクラスタを組む方法  
2.Discoveryと呼ばれている動的にクラスタを組む方法  
　  
etcd概要  
http://qiita.com/pocket8137/items/ef44ca68ffc0f4e70995  
［入門編］etcdでクラスタを構築する  
http://qiita.com/coreos/items/2e4ca397031d368832c4  

- - - 
　  
## (5)flannel
複数ホスト間で複数コンテナ間の通信を行える  
http://qiita.com/umchifre/items/74abfa8dfb054c87d168  
http://qiita.com/dtan4/items/8f9cf40aabd2e6c9a494  
　  
- - - 
　  
## (6)ntpd
ntp：ホストにもなれる  
systemd-timesyncd：クライアントのみ  


### ホストOSのtimezone設定(UTC→Japan)
```
# 現在の時刻設定を確認
$ date
=> Thu Feb 23 11:42:31 UTC 2017
```

```
# cloud-config.ymlにｔｉｍｅｚｏｎｅの設定
coreos:
  units:
  - name: settimezone.service
    command: start
    content: |
      [Unit]
      Description=Set the timezone
      [Service]
      ExecStart=/usr/bin/ln -sf ../usr/share/zoneinfo/Japan /etc/localtime
      RemainAfterExit=yes
      Type=oneshot
```

```
# cloud-config.ymlの設定を反映
$ sudo coreos-cloudinit -from-file=./cloud-config.yml
```

```
# 設定後の時刻設定を確認
$ date
=> Thu Feb 23 20:43:44 JST 2017
```

### ホストOSの時刻同期先の設定

#### デフォルト設定の確認
```
# /etc/ntp.confのデフォルト設定
# Common pool
server 0.coreos.pool.ntp.org
server 1.coreos.pool.ntp.org
server 2.coreos.pool.ntp.org
server 3.coreos.pool.ntp.org

# Warning: Using default NTP settings will leave your NTP
# server accessible to all hosts on the Internet.

# If you want to deny all machines (including your own)
# from accessing the NTP server, uncomment:
#restrict default ignore

# Default configuration:
# - Allow only time queries, at a limited rate, sending KoD when in excess.
# - Allow all local queries (IPv4, IPv6)
restrict default nomodify nopeer noquery limited kod
restrict 127.0.0.1
restrict [::1]
```

#### cloud-config.ymlに設定
時刻同期先サーバーの設定、既存ｃｏｒｅＯＳの時刻同期デーモンの停止、新規時刻同期デーモンの起動
```
# 公開NTPサーバーを指定(ntp.jst.mfeed.ad.jp)
write_files:
- path: /etc/ntp.conf
    content: |
      # Common pool
      server ntp.jst.mfeed.ad.jp
      # - Allow only time queries, at a limited rate.
      # - Allow all local queries (IPv4, IPv6)
      restrict default nomodify nopeer noquery limited kod
      restrict 127.0.0.1
      restrict [::1]
coreos:
  units:
  # "stop" default coreOS NTP daemon
  - name: systemd-timesyncd.service
    command: stop
    mask: true
  # "start" new user NTP daemon
  - name: ntpd.service
    command: start
    enable: true
```

```
# cloud-config.ymlの設定を反映
$ sudo coreos-cloudinit -from-file=./cloud-config.yml
```
```
# ntpdの状態確認(ntpd起動前)
$ systemctl status ntpd
=>● ntpd.service - Network Time Service
=>  Loaded: loaded (/usr/lib/systemd/system/ntpd.service; disabled; vendor preset: disabled)
=>  Active: inactive (dead)

# ntpdの状態確認(ntpd起動後)
$ systemctl status ntpd
=>● ntpd.service - Network Time Service
=>   Loaded: loaded (/usr/lib/systemd/system/ntpd.service; enabled; vendor preset: disabled)
=>   Active: active (running) since Thu 2017-02-23 21:59:09 JST; 2min 4s ago
=> Main PID: 739 (ntpd)
=>    Tasks: 2
=>   Memory: 5.7M
=>      CPU: 31ms
=>   CGroup: /system.slice/ntpd.service
=>           ├─739 /usr/sbin/ntpd -g -n -f /var/lib/ntp/ntp.drift -u ntp:ntp
=>           └─773 /usr/sbin/ntpd -g -n -f /var/lib/ntp/ntp.drift -u ntp:ntp

# 既存coreOSのntpdの状態確認(ntpd起動後)
$ systemctl status systemd-timesyncd ntpd
=>● systemd-timesyncd.service
=>   Loaded: masked (/dev/null; bad)
=>   Active: inactive (dead)

# ntpdが同期したか確認
$ ntpq -p
=>      remote           refid      st t when poll reach   delay   offset  jitter
=> ==============================================================================
=> *ntp1.jst.mfeed. 133.243.236.17   2 u   38   64  377    0.792   -0.026   0.389
※remoteのサーバー名の前に「*」が付いていたら同期完了している、とのこと
```

- - - 
　  
## (6)複数コンテナ管理
docker-compose.ymlで、MySQL,nginx,appの設定  
http://qiita.com/yoshihiro/items/2aa7d3baff94cc1016ee  
各コンテナの時刻設定は、「/etc/localtime」  
http://qiita.com/Gin/items/9f22ce8639aaa9f656dc  
```
# ホストOSの時刻設定を見る
$ docker run -v /etc/localtime:/etc/localtime:ro
```
再起動後もコンテナを自動起動する  
http://qiita.com/tukiyo3/items/928d1902db6372e491c2  
http://techblog.kayac.com/advent_calendar_2015_18.html
あなたは今どのコンテナ・オーケストレーションツールとマネージメントツールを使っていますか？  
https://www.creationline.com/lab/13762  

- - - 
　  
## サーバー監視

### New Relic


- - - 
　  
## (x)クラスタ
CoreOSを使ってDockerコンテナを動かす——15分でできるCoreOSクラスタの作り方  
http://knowledge.sakura.ad.jp/tech/3390/  

- - - 
　  
## (x)Supervisor
適当なスクリプトをデーモン化する  
http://blog.anatoo.jp/entry/20120310/1331321778  
Supervisorで簡単にデーモン化  
http://qiita.com/yushin/items/15f4f90c5663710dbd56  

- - - 
　  
## (x)Kubernetes(Container orchestration)(たぶん使わなそう)
[公式ドキュメント](https://kubernetes.io/docs/)  
CoreOS will remove fleet from Container Linux on February 1, 2018  
https://coreos.com/blog/migrating-from-fleet-to-kubernetes.html  
※ fleet : コンテナを動かすスケジューリングとコンテナの管理(2018/02/0以降CoreOSから外れる)  
Kubernetes をこれから始める人に抑えてほしい！フォローすべきユーザーと読むべきもの一覧  
https://www.wantedly.com/companies/wantedly/post_articles/30236  
Kubernetes: コンテナが起動するまでの各コンポーネントの流れ  
http://qiita.com/tkusumi/items/346d41a6240590b899cd  
Kubernetes の学習 (2) ～ Pod の作成  
http://qiita.com/Arturias/items/62499b961b5d7375f608  
　  
   
- - - 
　  
## index
<a href="./readme.md">readme.md</a>  
<a href="./1.OSインストール.md">1.OSインストール</a>  
<a href="./2.OS設定.md">2.OS設定</a>  
3.Units設定  
<a href="./4.コンテナにいれるアプリケーション.md">4.コンテナにいれるアプリケーション</a>  
　  
