# 3.Units設定
　  
　  
<a id="anc1" name="anc1"></a>





- - - 
　  
## httpsでサービス起ち上げ
(1)[jwilder/nginx-proxy](https://hub.docker.com/r/jwilder/nginx-proxy/)  
(2)[jrcs/letsencrypt-nginx-proxy-companion](https://hub.docker.com/r/jrcs/letsencrypt-nginx-proxy-companion/)  
(3)自分のサービスコンテナ  
　  

(1)[【jwilder/nginx-proxy:alpine】](https://hub.docker.com/r/jwilder/nginx-proxy/)
```cmd
$ sudo docker run -d -p 80:80 -p 443:443 \
  --name nginx-proxy \
  -v /path/to/certs:/etc/nginx/certs:ro \
  -v /etc/nginx/vhost.d \
  -v /usr/share/nginx/html \
  -v /var/run/docker.sock:/tmp/docker.sock:ro \
  --label com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true \
  jwilder/nginx-proxy:alpine
```

(2)[【jrcs/letsencrypt-nginx-proxy-companion】](https://hub.docker.com/r/jrcs/letsencrypt-nginx-proxy-companion/)
```cmd
$ sudo docker run -d \
  --name letsencrypt \
  -v /path/to/certs:/etc/nginx/certs:rw \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  --volumes-from nginx-proxy \
  jrcs/letsencrypt-nginx-proxy-companion
```

(3)自分のサービスコンテナ（https/http）
```cmd
# 【httpsの場合：nginx:alpine】
$ sudo docker run -d \
  --name nginx_サービス名 \
  -e "VIRTUAL_HOST=DOMAIN,www.DOMAIN" \
  -e "LETSENCRYPT_HOST=DOMAIN,www.DOMAIN" \
  -e "LETSENCRYPT_EMAIL=MAILADDRESS" \
  -it -p 8080:80 \
  nginx:alpine /bin/sh
```
```cmd
# 【httpの場合：nginx:alpine】
$ sudo docker run \
  --name nginx_サービス名 \
  -e "VIRTUAL_HOST=DOMAIN" \
  -it -p 8080:80 \
  nginx:alpine /bin/sh
```



- - - 
　  
## ()データベース
alipineコンテナにMySQLパッケージをインストール
http://qiita.com/celeron1ghz/items/a5f5e6932b666f425a07  
ボリュームマウント  
http://leko.jp/archives/896  
MySQL、MariaDBの比較  
https://www.firstlogic.co.jp/blog/lab/kimi/7030  
https://www.xyxon.co.jp/lineup/mariadb/comparison.html  
docker composeでMySQLのデータ領域をローカルにマウントする  
http://leko.jp/archives/896  



- - - 
　  
## (4)etcd
クラスタを構築する(2パターン)(サービスが大きくなったら使う？)  
1.あらかじめマシン数が決まっている場合に静的にクラスタを組む方法  
2.Discoveryと呼ばれている動的にクラスタを組む方法  
　  
etcd概要  
http://qiita.com/pocket8137/items/ef44ca68ffc0f4e70995  
［入門編］etcdでクラスタを構築する  
http://qiita.com/coreos/items/2e4ca397031d368832c4  

- - - 
　  
## (5)flannel
複数ホスト間で複数コンテナ間の通信を行える  
http://qiita.com/umchifre/items/74abfa8dfb054c87d168  
http://qiita.com/dtan4/items/8f9cf40aabd2e6c9a494  
　  
- - - 
　  
## (6)ntpd
ntp：ホストにもなれる  
systemd-timesyncd：クライアントのみ  


### ホストOSのtimezone設定(UTC→Japan)
```
# 現在の時刻設定を確認
$ date
=> Thu Feb 23 11:42:31 UTC 2017
```

```
# cloud-config.ymlにｔｉｍｅｚｏｎｅの設定
coreos:
  units:
  - name: settimezone.service
    command: start
    content: |
      [Unit]
      Description=Set the timezone
      [Service]
      ExecStart=/usr/bin/ln -sf ../usr/share/zoneinfo/Japan /etc/localtime
      RemainAfterExit=yes
      Type=oneshot
```

```
# cloud-config.ymlの設定を反映
$ sudo coreos-cloudinit -from-file=./cloud-config.yml
```

```
# 設定後の時刻設定を確認
$ date
=> Thu Feb 23 20:43:44 JST 2017
```

### ホストOSの時刻同期先の設定

#### デフォルト設定の確認
```
# /etc/ntp.confのデフォルト設定
# Common pool
server 0.coreos.pool.ntp.org
server 1.coreos.pool.ntp.org
server 2.coreos.pool.ntp.org
server 3.coreos.pool.ntp.org

# Warning: Using default NTP settings will leave your NTP
# server accessible to all hosts on the Internet.

# If you want to deny all machines (including your own)
# from accessing the NTP server, uncomment:
#restrict default ignore

# Default configuration:
# - Allow only time queries, at a limited rate, sending KoD when in excess.
# - Allow all local queries (IPv4, IPv6)
restrict default nomodify nopeer noquery limited kod
restrict 127.0.0.1
restrict [::1]
```

#### cloud-config.ymlに設定
時刻同期先サーバーの設定、既存ｃｏｒｅＯＳの時刻同期デーモンの停止、新規時刻同期デーモンの起動
```
# 公開NTPサーバーを指定(ntp.jst.mfeed.ad.jp)
write_files:
- path: /etc/ntp.conf
    content: |
      # Common pool
      server ntp.jst.mfeed.ad.jp
      # - Allow only time queries, at a limited rate.
      # - Allow all local queries (IPv4, IPv6)
      restrict default nomodify nopeer noquery limited kod
      restrict 127.0.0.1
      restrict [::1]
coreos:
  units:
  # "stop" default coreOS NTP daemon
  - name: systemd-timesyncd.service
    command: stop
    mask: true
  # "start" new user NTP daemon
  - name: ntpd.service
    command: start
    enable: true
```

```
# cloud-config.ymlの設定を反映
$ sudo coreos-cloudinit -from-file=./cloud-config.yml
```
```
# ntpdの状態確認(ntpd起動前)
$ systemctl status ntpd
=>● ntpd.service - Network Time Service
=>  Loaded: loaded (/usr/lib/systemd/system/ntpd.service; disabled; vendor preset: disabled)
=>  Active: inactive (dead)

# ntpdの状態確認(ntpd起動後)
$ systemctl status ntpd
=>● ntpd.service - Network Time Service
=>   Loaded: loaded (/usr/lib/systemd/system/ntpd.service; enabled; vendor preset: disabled)
=>   Active: active (running) since Thu 2017-02-23 21:59:09 JST; 2min 4s ago
=> Main PID: 739 (ntpd)
=>    Tasks: 2
=>   Memory: 5.7M
=>      CPU: 31ms
=>   CGroup: /system.slice/ntpd.service
=>           ├─739 /usr/sbin/ntpd -g -n -f /var/lib/ntp/ntp.drift -u ntp:ntp
=>           └─773 /usr/sbin/ntpd -g -n -f /var/lib/ntp/ntp.drift -u ntp:ntp

# 既存coreOSのntpdの状態確認(ntpd起動後)
$ systemctl status systemd-timesyncd ntpd
=>● systemd-timesyncd.service
=>   Loaded: masked (/dev/null; bad)
=>   Active: inactive (dead)

# ntpdが同期したか確認
$ ntpq -p
=>      remote           refid      st t when poll reach   delay   offset  jitter
=> ==============================================================================
=> *ntp1.jst.mfeed. 133.243.236.17   2 u   38   64  377    0.792   -0.026   0.389
※remoteのサーバー名の前に「*」が付いていたら同期完了している、とのこと
```

- - - 
　  
## (6)複数コンテナ管理
docker-compose.ymlで、MySQL,nginx,appの設定  
http://qiita.com/yoshihiro/items/2aa7d3baff94cc1016ee  
各コンテナの時刻設定は、「/etc/localtime」  
http://qiita.com/Gin/items/9f22ce8639aaa9f656dc  
```
# ホストOSの時刻設定を見る
$ docker run -v /etc/localtime:/etc/localtime:ro
```
再起動後もコンテナを自動起動する  
http://qiita.com/tukiyo3/items/928d1902db6372e491c2  
http://techblog.kayac.com/advent_calendar_2015_18.html
あなたは今どのコンテナ・オーケストレーションツールとマネージメントツールを使っていますか？  
https://www.creationline.com/lab/13762  

- - - 
　  
## サーバー監視

### New Relic


- - - 
　  
## (x)クラスタ
CoreOSを使ってDockerコンテナを動かす——15分でできるCoreOSクラスタの作り方  
http://knowledge.sakura.ad.jp/tech/3390/  

- - - 
　  
## (x)Supervisor
適当なスクリプトをデーモン化する  
http://blog.anatoo.jp/entry/20120310/1331321778  
Supervisorで簡単にデーモン化  
http://qiita.com/yushin/items/15f4f90c5663710dbd56  

- - - 
　  
## (x)Kubernetes(Container orchestration)(たぶん使わなそう)
[公式ドキュメント](https://kubernetes.io/docs/)  
CoreOS will remove fleet from Container Linux on February 1, 2018  
https://coreos.com/blog/migrating-from-fleet-to-kubernetes.html  
※ fleet : コンテナを動かすスケジューリングとコンテナの管理(2018/02/0以降CoreOSから外れる)  
Kubernetes をこれから始める人に抑えてほしい！フォローすべきユーザーと読むべきもの一覧  
https://www.wantedly.com/companies/wantedly/post_articles/30236  
Kubernetes: コンテナが起動するまでの各コンポーネントの流れ  
http://qiita.com/tkusumi/items/346d41a6240590b899cd  
Kubernetes の学習 (2) ～ Pod の作成  
http://qiita.com/Arturias/items/62499b961b5d7375f608  
　  
   
- - - 
　  
## index
<a href="./readme.md">readme.md</a>  
<a href="./1.OSインストール.md">1.OSインストール</a>  
<a href="./2.OS設定.md">2.OS設定</a>  
3.Units設定  
<a href="./4.コンテナにいれるアプリケーション.md">4.コンテナにいれるアプリケーション</a>  
　  
